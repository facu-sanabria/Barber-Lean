<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel del Peluquero — Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-3xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-gray-800">Panel del Peluquero</h1>
      <p class="text-sm text-gray-500">Ver, cancelar y cerrar días completos</p>
    </header>

    <!-- Filtros / acciones -->
    <div class="bg-white rounded-lg shadow p-4 mb-4">
      <div class="flex flex-wrap items-center gap-2">
        <label class="text-sm text-gray-700">Fecha</label>
        <input id="date" type="date" class="border rounded px-2 py-1" />
        <button id="load" class="px-3 py-1 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700">Cargar</button>
        <button id="clear" class="px-3 py-1 rounded border text-sm">Quitar filtro</button>
      </div>

      <div class="mt-3 flex items-center gap-2">
        <span id="closed-badge" class="hidden text-sm px-2 py-1 rounded-full bg-red-100 text-red-700">Día cerrado</span>
        <button id="toggle-close" class="px-3 py-1 rounded text-sm border">Cargar…</button>
      </div>
    </div>

    <!-- Lista -->
    <div id="list" class="bg-white rounded-lg shadow divide-y"></div>
  </div>

  <script>
    // Elementos
    const dateInput = document.getElementById('date');
    const loadBtn = document.getElementById('load');
    const clearBtn = document.getElementById('clear');
    const listEl = document.getElementById('list');
    const toggleCloseBtn = document.getElementById('toggle-close');
    const closedBadge = document.getElementById('closed-badge');

    // Utils
    function todayStr() {
      const t = new Date();
      const yyyy = t.getFullYear();
      const mm = String(t.getMonth()+1).padStart(2,'0');
      const dd = String(t.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // API helpers
    async function fetchBookings() {
      const date = dateInput.value;
      const url = date ? `/api/bookings?date=${date}` : '/api/bookings';
      const res = await fetch(url);
      return res.ok ? res.json() : [];
    }
    async function fetchClosures() {
      const res = await fetch('/api/closures');
          return res.ok ? res.json() : [];
        }
        async function isClosed(date) {
          const closures = await fetchClosures();
          const normalizedClosures = closures.map(d => String(d).slice(0, 10));
          return normalizedClosures.includes(date);
        }

        async function setClosed(date, closed) {
          if (closed) {
            const res = await fetch('/api/closures', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ date })
        });
        return res.ok;
      } else {
        const res = await fetch(`/api/closures/${date}`, { method: 'DELETE' });
        return res.ok;
      }
    }

    // UI
    async function renderClosureUI() {
      const date = dateInput.value;
      const closed = date ? await isClosed(date) : false;

      closedBadge.classList.toggle('hidden', !closed);

      toggleCloseBtn.textContent = closed ? 'Reabrir día' : 'Cerrar día';
      toggleCloseBtn.className = closed
        ? 'px-3 py-1 rounded text-sm bg-green-600 text-white hover:bg-green-700'
        : 'px-3 py-1 rounded text-sm bg-red-600 text-white hover:bg-red-700';

      listEl.dataset.closed = closed ? '1' : '0';
    }

    async function render() {
      await renderClosureUI();

      listEl.innerHTML = '';
      const items = await fetchBookings();
      const closed = listEl.dataset.closed === '1';

      if (closed) {
        const note = document.createElement('div');
        note.className = 'p-3 mb-2 text-sm rounded bg-red-50 text-red-700 border border-red-200';
        note.textContent = 'Este día está cerrado: no se pueden tomar nuevos turnos. (Los turnos existentes se muestran abajo y podés cancelarlos si querés.)';
        listEl.appendChild(note);
      }

      if (!items.length) {
        listEl.innerHTML += `<div class="p-4 text-sm text-gray-500">No hay turnos para esa fecha.</div>`;
        return;
      }

      items.forEach(b => {
        const row = document.createElement('div');
        row.className = 'p-4 flex items-center justify-between';
        row.innerHTML = `
          <div>
            <div class="font-medium text-gray-800">${b.nombre} ${b.apellido}</div>
            <div class="text-sm text-gray-500">${b.date} — ${b.time}</div>
          </div>
          <button data-id="${b.id}" class="cancel px-3 py-1 text-sm rounded border hover:bg-red-50 hover:text-red-700">Cancelar</button>
        `;
        listEl.appendChild(row);
      });

      document.querySelectorAll('.cancel').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          if (!confirm('¿Cancelar este turno?')) return;
          const res = await fetch(`/api/book/${id}`, { method: 'DELETE' });
          if (res.ok) render();
          else alert('No se pudo cancelar.');
        });
      });
    }

    // Eventos
    toggleCloseBtn.addEventListener('click', async () => {
      const date = dateInput.value;
      if (!date) { alert('Elegí una fecha primero.'); return; }
      const closed = await isClosed(date);
      const ok = await setClosed(date, !closed);
      if (!ok) { alert('No se pudo cambiar el estado del día.'); return; }
      await render();
    });

    loadBtn.addEventListener('click', render);
    clearBtn.addEventListener('click', () => { dateInput.value = ''; render(); });
    dateInput.addEventListener('change', render);
    window.addEventListener('focus', render);

    // Default: hoy
    if (!dateInput.value) dateInput.value = todayStr();

    render();
  </script>
</body>
</html>
